// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","./RasterFunctionX","./pixelShaders","./vertexShaders","./webglHelper","./convolutionKernel"],(function(e,t,r,i,n,s,a){return e(null,{gl:null,rgbaFloatData:null,originalTexture:null,lastTexture:null,renderTexture:!1,constructor:function(e){this._isProgramInitialized=!1,this.gl=e&&e.gl,e&&e.renderTexture&&(this.renderTexture=e.renderTexture),this._xformSetting=e&&e._xformSetting||{requireProjection:!1,meshSize:[20,20]}},bindFrameBuffer:function(){var e,t=this.gl;this._setupPingPongTextures(),this._setupBranchingTextures();var r=this._glSetting;return this.isBranch?(r.branchIndex=(r.branchIndex+1)%r.branchCount,e=r.branches[r.branchIndex]):(r.pingpongIndex=(r.pingpongIndex+1)%r.pingpong.length,e=r.pingpong[r.pingpongIndex]),t.bindFramebuffer(t.FRAMEBUFFER,e.frameBuffer),t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight),e},_initializeProgram:function(e){if(this.gl)try{var t=this.gl,r=t.drawingBufferWidth,a=t.drawingBufferHeight;t.viewport(0,0,r,a);var o=this._glSetting.programUniforms,g="local"===this.functionName?"local"+this.functionArguments.operation:this.functionName,h=o[g];if(h)this._uniforms=h.uniforms,this.rasterProgram=h.program;else{this._useMesh=this._tileMode&&this._xformSetting.requireProjection;var u=this._useMesh?n.mesh:n.basic,f=n.getShader(t,e.vertex||u),_=i.getShader(t,e.fragment),l=this._loadProgram(f,_),m={rasterProgram:s.getUniforms(t,l)};o[g]={uniforms:m,program:l},this.rasterProgram=l,this._uniforms=m}t.useProgram(this.rasterProgram);var x=t.getAttribLocation(this.rasterProgram,"a_texCoord"),c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c);var d=s.createMesh(this._xformSetting.meshSize);t.bufferData(t.ARRAY_BUFFER,d,t.STATIC_DRAW),t.enableVertexAttribArray(x),t.vertexAttribPointer(x,2,t.FLOAT,!1,0,0),t.disable(t.DEPTH_TEST),t.blendFunc(t.SRC_ALPHA,t.ZERO),t.disable(t.BLEND),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this._shaderInfo={fragment:e.fragmentName}}catch(e){return void console.error("webgl exception: "+e.message)}else console.error("WebGL is required.")},_setUniform:function(e,t,r){if(null!=t){r&&!this._uniforms[r]&&(this._uniforms[r]=s.getUniforms(this.gl,this[r]));var i=r?this._uniforms[r]:this._uniforms.rasterProgram,n=i[e]||i[e+"[0]"];n&&s.setUniform(this.gl,n,t)}},_setUniforms:function(e,t){var r,i,n,s=Object.keys(e),a=s.length;for(r=0;r<a;r++)this._setUniform(s[r],e[s[r]],t);this.rawInput?this._setUniform("u_flipY",!0,t):this._setUniform("u_flipY",!1,t),this._tileMode?(this.rawInput?(i=this._xformSetting.offset,n=this._xformSetting.scale):(i=[0,0],n=[1,1]),this._setUniform("u_xformOffset",i,t),this._setUniform("u_xformScale",n,t),this._xformSetting.requireProjection&&(this.rawInput?(this._setupXformTexture(),this._setUniform("u_projection",!0,t),this._setUniform("u_transformGridSize",this._xformSetting.gridConfig.size,t),this._setUniform("u_transformSpacing",this._xformSetting.gridConfig.spacing,t),this._setUniform("u_targetImageSize",new Float32Array([this.gl.drawingBufferWidth,this.gl.drawingBufferHeight]),t)):this._setUniform("u_projection",!1,t))):(i=[0,0],n=[1,1],this._setUniform("u_xformOffset",i,t),this._setUniform("u_xformScale",n,t))},_setupTextureData:function(e,t){if(e.texture)return e;e.raster&&e.raster.pixelBlock&&(e=e.raster),this.rawInput=!0;var r,i=t&&t.notOriginal,n=t&&t.bandIDs;if(t&&t.reCreate?r=!1:(r=this._tileMode?!this._xformSetting.hasNewTexture:!this._glSetting.hasNewTexture)&&this._originalBandIDs&&(r=!!n&&this._originalBandIDs.join("")===n.join("")),this._glSetting.branchCount>0&&(r=!1),r&&this.originalTexture)return{extent:e.extent,texture:this.originalTexture};var s=this._createTexture();i||(this.originalTexture=s,this._originalBandIDs=n);var a=this.gl,o=e.pixelBlock,g=0;n&&n.length>0&&o&&(g=Math.max.apply(null,n),o.pixels.length>g&&n&&(o.pixels=n.map((function(e){return o.pixels[e]})),o.statistics&&(o.statistics=n.map((function(e){return o.statistics[e]})))));var h=o.width,u=o.height;a.getExtension("OES_texture_float");var f=o.getAsRGBAFloat();return a.texImage2D(a.TEXTURE_2D,0,a.RGBA,h,u,0,a.RGBA,a.FLOAT,f),{extent:e.extent,texture:s}},_setupPingPongTextures:function(){var e=this._glSetting;if(!e||!e.pingpong){e.pingpong=[];var t=s.createBufferTexture(this.gl,!1);e.pingpong.push(t),t=s.createBufferTexture(this.gl,!1),e.pingpong.push(t),e.pingpongIndex=1}},_setupBranchingTextures:function(){var e=this._glSetting;if(!e||!e.branches){e.branches=[];var t,r=0,i=e.branchCount;if(i>0){for(r=0;r<i;r++)t=s.createBufferTexture(this.gl,!1),e.branches.push(t);e.branchIndex=i-1}}},_setupXformTexture:function(e){for(var t=this._createTexture(),r=this.gl,i=4*this._xformSetting.gridConfig.size[0],n=this._xformSetting.gridConfig.size[1],s=new Float32Array(i*n*4),a=0,o=0;o<this._xformSetting.gridConfig.coefficients.length;o++)s[a++]=this._xformSetting.gridConfig.coefficients[o],o%3==2&&(s[a++]=1);r.getExtension("OES_texture_float"),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,i,n,0,r.RGBA,r.FLOAT,s),this._bindTexture(t,"u_transformGrid",e)},_createTexture:function(e){return s.createTexture(this.gl,e)},_bindTexture:function(e,t,r){t=t||"u_image",r=r||"rasterProgram";var i=this._uniforms[r],n=this._getTextureIndex(t);if(-1!==n){var s=i[t].location,a=this.gl;a.uniform1i(s,n),a.activeTexture(a.TEXTURE0+n),a.bindTexture(a.TEXTURE_2D,e)}},_getTextureIndex:function(e,t){t=t||"rasterProgram";var r=this._uniforms[t];if(!r||!r[e]||r[e].info.type!==this.gl.SAMPLER_2D)return-1;if("u_transformGrid"===e)return 0;var i="u_image"===e?0:parseInt(e.replace("u_image",""));return this._xformSetting.requireProjection?i+1:i},_drawGL:function(e){var t=this.gl;this.renderTexture?(t.enable(t.BLEND),t.bindFramebuffer(t.FRAMEBUFFER,null)):t.disable(t.BLEND),e||t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight);var r=this._xformSetting.meshSize||[1,1];t.drawArrays(t.TRIANGLES,0,r[0]*r[1]*6),this._drawMesh()},_drawMesh:function(){if(this.renderTexture&&this._glSetting.drawMesh){this.meshProgram=this.meshProgram||this._setupMeshProgram();var e=this.gl;e.useProgram(this.meshProgram),e.bindFramebuffer(e.FRAMEBUFFER,null);var t=e.getAttribLocation(this.meshProgram,"a_texCoord"),r=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,r);var i=this._xformSetting.meshSize||[1,1],n=s.createMesh(i,!0);e.bufferData(e.ARRAY_BUFFER,n,e.STATIC_DRAW),e.enableVertexAttribArray(t),e.vertexAttribPointer(t,2,e.FLOAT,!1,0,0),e.disable(e.DEPTH_TEST),e.blendFunc(e.ONE,e.ZERO),this._setUniforms({u_color:[0,0,1,1],u_drawMeshLines:!0},"meshProgram"),e.drawArrays(e.LINES,0,i[0]*i[1]*10)}},_setupMeshProgram:function(){var e=n.getShader(this.gl,n.mesh),t=i.getShader(this.gl,i.constant);return this._loadProgram(e,t)},_loadProgram:function(e,t){return s.loadProgram(this.gl,e,t)},_getShaderScript:function(e,t){var r=document.getElementById(t);if(!r)return null;for(var i="",n=r.firstChild;n;)3==n.nodeType&&(i+=n.textContent),n=n.nextSibling;return i}})}));