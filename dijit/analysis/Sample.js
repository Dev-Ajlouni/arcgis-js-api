// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/connect","dojo/has","dojo/dom-class","dojo/dom-style","dojo/string","dojo/dom-construct","dojo/query","dojo/dom-attr","dojo/store/Memory","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/CheckBox","dijit/form/Select","dijit/form/ComboBox","../../kernel","../../lang","./RasterAnalysisMixin","./utils","./AnalysisRegistry","./ItemTypes","../RasterFunctionEditor/utils","dojo/i18n!../../nls/jsapi","dojo/i18n!./nls/Sample","dojo/text!./templates/Sample.html"],(function(e,t,i,s,a,n,l,r,o,h,u,d,c,_,y,m,f,p,g,v,L,b,D,F,V,O,T,A,S,I,R,E){var N=e([_,y,m,f,p,V],{declaredClass:"esri.dijit.analysis.Sample",templateString:E,widgetsInTemplate:!0,inputLayer:null,locationLayer:null,uniqueIdField:null,acquisitionDefinition:null,bufferDistance:null,statisticsType:"MEAN",percentileValue:null,resamplingType:"NEAREST",layout:"ROW_WISE",generateFeatureClass:!1,outputTableName:null,_emptyValue:"NONE",toolName:"Sample",helpFileName:"Sample",toolNlsName:I.sampleTool,rasterGPToolName:"Sample",resultParameter:"outSample",analysisType:"feature",outputName:"outputName",browseType:[A.IS],hasCustomCheck:!0,customCheckFailureMessage:I.customCheckFailureMessage.integerService,constructor:function(e,t){this._pbConnects=[],this._rasterRows=[],e.containerNode&&(this.container=e.containerNode),e.rerun&&(e.inputRasterLayers=e.inRasters,e.locationLayer=e.inLocationData)},postMixInProperties:function(){this.inherited(arguments),t.mixin(this.i18n,R)},_getJobParameters:function(){var e={inRasters:s.toJson(this.get("inRasters")),inLocationData:s.toJson(this.get("locationData")),uniqueIdField:this.get("uniqueIdField"),resamplingType:this.get("resamplingType"),generateFeatureClass:this.get("generateFeatureClass"),acquisitionDefinition:s.toJson(this.get("acquisitionDefinition")),statisticsType:this.get("statisticsType"),layout:this.get("layout"),bufferDistance:this.get("bufferDistance"),percentileValue:this.get("percentileValue")};return this._variableList&&this._variableList.length>0&&t.mixin(e,{processAsMultidimensional:!0}),e},_setDefaultInputs:function(){var e=0;this.locationLayers&&i.forEach(this.locationLayers,(function(t,i){this._layersSelect.addOption({value:i,label:t.name}),0!==i||this.rerun?this.locationLayer&&t.name===this.locationLayer.name&&t.url===this.locationLayer.url&&(e=i):this.set("locationLayer",t)}),this),this.locationLayer&&e>0&&this._layersSelect.set("value",e),this.statisticsType&&this._loadStatisticsType(!0),this.resamplingType&&this._loadResamplingType(!0),this.uniqueIdField&&this._uniqueIdField.set("value",this.uniqueIdField),this.percentileValue&&this._percentileValue.set("value",this.percentileValue),this.dimensionField&&this._dimensionField.set("value",this.dimensionField),this.dimensionFieldOrValue&&this._dimensionFieldOrValue.set("value",this.dimensionFieldOrValue),this.relativeValueOrDaysBefore&&this._relativeValueOrDaysBefore.set("value",this.relativeValueOrDaysBefore),this.relativeValueOrDaysAfter&&this._relativeValueOrDaysAfter.set("value",this.relativeValueOrDaysAfter),this.bufferDistance&&this._bufferDistance.set("value",this.bufferDistance),this.startFieldOrValue&&this._startFieldOrValue.set("value",this.startFieldOrValue),this.endFieldOrValue&&this._endFieldOrValue.set("value",this.endFieldOrValue),this._updateDimensionSection()},_resetUI:function(){if(this.set("uniqueIdField",this.uniqueIdField),this.inputLayer){this.outputLayerName=o.substitute(this.i18n.outputLayerName,{layername:this.inputLayer.name}),this._outputLayerInput.set("value",this.outputLayerName),this._variableList=null,this.isMultidimensionalLayer(this.inputLayer)&&this.inputLayer.getMultidimensionalInfo().then(t.hitch(this,(function(e){this._variableList=e.variables,this._updateDimensionSection(),this._updateStatsVisibility()}))),this._updateDimensionSection(),this._updateStatsVisibility();var e=!0;u(".rasterSelect",this.domNode).forEach((function(t){t.value===this._emptyValue&&(e=!1)})),e&&(this._removeRasterRows(),this._createInRasterRow(),O.addReadyToUseLayerOption(this,[{disableLAAL:!0,select:this._currentRasterSelect}]))}},addBrowseOption:function(){O.addReadyToUseLayerOption(this,[{disableLAAL:!0,select:this._layersSelect}])},_loadStatisticsType:function(e){this._statisticsType.removeOption(this._statisticsType.getOptions());var t=e&&this.statisticsType;this._statisticsType.addOption([{value:"MEAN",label:this.i18n.mean,selected:"MEAN"===t},{value:"MAJORITY",label:this.i18n.majority,selected:"MAJORITY"===t},{value:"MAXIMUM",label:this.i18n.maximum,selected:"MAXIMUM"===t},{value:"MEDIAN",label:this.i18n.median,selected:"MEDIAN"===t},{value:"MINIMUM",label:this.i18n.minimum,selected:"MINIMUM"===t},{value:"MINORITY",label:this.i18n.minority,selected:"MINORITY"===t},{value:"STD",label:this.i18n.standardDeviation,selected:"STD"===t},{value:"SUM",label:this.i18n.sum,selected:"SUM"===t},{value:"PERCENTILE",label:this.i18n.percentile,selected:"PERCENTILE"===t}])},_loadResamplingType:function(e){this._resamplingType.removeOption(this._resamplingType.getOptions());var t=e&&this.resamplingType;this._resamplingType.addOption([{value:"NEAREST",label:this.i18n.nearest,selected:"NEAREST"===t},{value:"BILINEAR",label:this.i18n.bilinear,selected:"BILINEAR"===t},{value:"CUBIC",label:this.i18n.cubic,selected:"CUBIC"===t}])},isMultidimensionalLayer:function(e){return e.hasMultidimensions},_showDiv:function(e,t){l.toggle(e,"show",t),l.toggle(e,"hide",!t)},_handleLocationLayerChange:function(e){"browselayers"===e||"browse"===e?(this._isAnalysisSelect=!1,this._isMoreAnalysisSelect=!1,this.defaultItemTypes=[],this.set("allowedItemTypes",[A.IS,A.FS]),this._createBrowseItems({browseValue:e,disableLAAL:!0,disableBoundary:!0},{},this._layersSelect)):(this.set("locationLayer",this.locationLayers[e]),this.inputLayer&&(this.outputLayerName=o.substitute(this.i18n.outputLayerName,{layername:this.inputLayer.name}),this._outputLayerInput.set("value",this.outputLayerName))),this.set("uniqueIdField",null)},_handleBrowseItemsSelect:function(e,i){e&&e.selection&&O.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.inputLayers:this.locationLayers,layersSelect:this._isAnalysisSelect?this._isMoreAnalysisSelect?this._currentLayersSelect:this._analysisSelect:this._layersSelect,browseDialog:this._browseLyrsdlg||this._browsedlg,widget:this},i).always(t.hitch(this,(function(){this._isAnalysisSelect?this._isMoreAnalysisSelect?this._handleInRasterLayerChange(this._currentLayersSelect.get("value")):this._handleAnalysisLayerChange(this._analysisSelect.get("value")):this._handleLocationLayerChange(this._layersSelect.get("value"))}))),this._isMoreAnalysisSelect=!1},_handleFormatRadioChange:function(e){this._updateFormatSelection()},_handleFormatRadioChangeZ:function(e){this._updateFormatSelection(!0)},_handleOptionsBtnClick:function(){l.contains(this._optionsDiv,"disabled")||(l.toggle(this._optionsDiv,"optionsOpen",l.contains(this._optionsDiv,"optionsClose")),l.toggle(this._optionsDiv,"optionsClose",!l.contains(this._optionsDiv,"optionsClose")))},_handleOptionsBtnClickZ:function(){l.contains(this._optionsDivZ,"disabled")||(l.toggle(this._optionsDivZ,"optionsOpen",l.contains(this._optionsDivZ,"optionsClose")),l.toggle(this._optionsDivZ,"optionsClose",!l.contains(this._optionsDivZ,"optionsClose")))},_handleDimensionClicked:function(e,t){l.toggle(e,"disabled",!t),l.toggle(e,"optionsClose",!t),l.toggle(e,"optionsOpen",t)},_handleTimeDimensionClicked:function(e){this._handleFormatRadioChange(),this._handleDimensionClicked(this._optionsDiv,e)},_handleZDimensionClicked:function(e){this._handleFormatRadioChangeZ(),this._handleDimensionClicked(this._optionsDivZ,e)},_handleStatisticsTypeChange:function(){var e="PERCENTILE"===this._statisticsType.get("value");u(".percentile",this.domNode).forEach((function(t){this._showDiv(t,e)}),this)},_handleBufferChange:function(){var e=this.get("bufferDistance");u(".statisticsType",this.domNode).forEach((function(t){this._showDiv(t,e)}),this)},_refreshFields:function(e,t,s){if(t)i.forEach(e,(function(e){e.reset()}));else{var a=new c({data:s,idProperty:"value"});i.forEach(e,(function(e){e.set("store",a)}))}},_handleInRasterSelectChange:function(e,i,s){var a,n=this.get("referenceWidget");"browselayers"===s||"browse"===s?(n._isAnalysisSelect=!0,n._isMoreAnalysisSelect=!0,n._currentLayersSelect=this,n.defaultItemTypes=[],n.set("allowedItemTypes",[A.IS,A.FS]),n._createBrowseItems({browseValue:s,disableLAAL:!0,disableBoundary:!0},{},this)):s&&"NONE"!=s&&(this.get("isnewRowAdded")||(a=this.get("removeTd"),r.set(a,"display","block"),t.hitch(n,n._createInRasterRow()),this.set("isnewRowAdded",!0)),this.set("value",s)),n._updateDimensionSection()},_handleInRasterLayerChange:function(e){},_createInRasterRow:function(){var e,i,s,n,l;return e=h.create("tr",null,this._inRastersDiv,"before"),i=h.create("td",{style:{width:"100%"}},e),(s=new L({class:"longInput rasterSelect esriLeadingMargin1 esriLongLabel",style:{tableLayout:"fixed",overflowX:"hidden"}},h.create("select",null,i))).removeOption(s.getOptions()),s.addOption([{value:this._emptyValue,label:""}]),s.addOption(this._analysisSelect.getOptions()),l=h.create("td",{class:"shortTextInput removeTd",style:{display:"none",maxWidth:"12px"}},e),n=h.create("a",{title:this.i18n.removeLayer,class:"closeIcon rasterRemove",innerHTML:"<img src='"+require.toUrl("./images/close.gif")+"' border='0''/>"},l),a.connect(n,"onclick",t.hitch(this,this._removeRasterRow,e)),this._rasterRows.push(e),s.set("removeTd",l),s.set("isnewRowAdded",!1),s.set("referenceWidget",this),s.watch("value",this._handleInRasterSelectChange),this._currentRasterSelect=s,!0},_removeRasterRow:function(e){i.forEach(g.findWidgets(e),(function(e){e.destroyRecursive()})),h.destroy(e),this._updateDimensionSection()},_removeRasterRows:function(){i.forEach(this._rasterRows,this._removeRasterRow,this),this._rasterRows=[]},_inRasterCount:function(){var e=0,t=this._emptyValue;return u(".rasterSelect",this.domNode).forEach((function(i){g.byNode(i).get("value")!=t&&e++})),e},_updateDimDiv:function(e){u(".dimensionsDiv",this.domNode).forEach((function(t){this._showDiv(t,e)}),this),u(".layout",this.domNode).forEach((function(t){this._showDiv(t,e)}),this),u(".stdTimeDiv",this.domNode).forEach((function(t){this._showDiv(t,e)}),this),u(".stdZDiv",this.domNode).forEach((function(t){this._showDiv(t,e)}),this)},_updateDimensionSection:function(){this._variableList&&0===this._inRasterCount()?this.set("variables",this._variableList):(d.set(this._resampleNumberLabel,"innerHTML",this.i18n.threeLabel),d.set(this._outputTypeNumberLabel,"innerHTML",this.i18n.fourLabel),d.set(this._outputLayerNumberLabel,"innerHTML",this.i18n.fiveLabel),this._updateDimDiv(!1))},_updateFormatSelection:function(e){var t=e?"formatZ":"format";this._aggregateTable.querySelectorAll("[name="+t+"]").forEach((function(e){e.checked?u("."+e.value,this[t]).forEach((function(e){this._showDiv(e,!0)}),this):u("."+e.value,this[t]).forEach((function(e){this._showDiv(e,!1)}),this)}),this),this._updateStatsVisibility()},_getIsValidFomat:function(){var e=!1;return l.contains(this._optionsDiv,"disabled")||this._aggregateTable.querySelectorAll("[name='format']").forEach((function(t){t.checked&&(e=t.value.startsWith("relativeValue")||t.value.startsWith("startEndValue"))})),e||l.contains(this._optionsDivZ,"disabled")||this._aggregateTable.querySelectorAll("[name='formatZ']").forEach((function(t){t.checked&&(e=t.value.startsWith("relativeValue")||t.value.startsWith("startEndValue"))})),e},_updateStatsVisibility:function(){var e=!1;this._variableList&&this._variableList.length>0&&(e=this._isPolyLayer||this.get("bufferDistance")||this._getIsValidFomat()),u(".statisticsType",this.domNode).forEach((function(t){this._showDiv(t,e)}),this)},_setInputLayersAttr:function(e){this.inputLayers=e},_getInputLayersAttr:function(){return this.inputLayers},_getInRastersAttr:function(){var e=[this.inputLayer],t=this.inputLayers,i=this._emptyValue;return u(".rasterSelect",this.domNode).forEach((function(s){var a=g.byNode(s).get("value");a!=i&&e.push(t[a])})),{urls:e.map((function(e){return S.getRasterJsonFromLayer(e).url}))}},_getLocatonLayerAttr:function(){return this.locationLayer=this.locationLayers[this._layersSelect.get("value")],this.locationLayer},_setLocationLayerAttr:function(e){this.locationLayer!==e&&(this.locationLayer=e,e&&(this._isPolyLayer=e.geometryType===T.GeometryTypes.Polygon||e.geometryType===T.GeometryTypes.Line),this.set("uniqueIdField",null),this._updateStatsVisibility())},_setLocationLayersAttr:function(e){this.locationLayers=e,this.set("locationLayer",this.locationLayers[0])},_getLocationLayersAttr:function(){return this.locationLayers},_getLocationDataAttr:function(){var e=this.get("locationLayer");return"Image Service"===e.type?S.getRasterJsonFromLayer(e):O.constructAnalysisInputLyrObj(e)},_setVariablesAttr:function(e){var t,s,a=!1,n=e.length;d.set(this._resampleNumberLabel,"innerHTML",this.i18n.fourLabel),d.set(this._outputTypeNumberLabel,"innerHTML",this.i18n.fiveLabel),d.set(this._outputLayerNumberLabel,"innerHTML",this.i18n.sixLabel),i.forEach(e,(function(e){var i=e.dimensions;a||(t=i),a&&JSON.stringify(t)!=JSON.stringify(i)&&(t=null),a=!0}),this);var l=u(".stdTimeDiv",this.domNode),r=u(".stdZDiv",this.domNode);u(".dimensionsDiv",this.domNode).forEach((function(e){this._showDiv(e,!0)}),this),u(".buffer",this.domNode).forEach((function(e){this._showDiv(e,!1)}),this),l.forEach((function(e){this._showDiv(e,!1)}),this),r.forEach((function(e){this._showDiv(e,!1)}),this),u(".layoutDiv",this.domNode).forEach((function(e){this._showDiv(e,!1)}),this),this._showDiv(this._dimensionError,!1),t?(t&&t.length>0&&(u(".buffer",this.domNode).forEach((function(e){this._showDiv(e,!0)}),this),i.forEach(t,(function(e){"StdTime"===e.name?s=l:"StdZ"===e.name&&(s=r),s.forEach((function(e){this._showDiv(e,!0)}),this)}),this)),this._handleFormatRadioChange(),this._handleFormatRadioChangeZ(),1===n&&1===t.length&&(u(".layoutDiv",this.domNode).forEach((function(e){this._showDiv(e,!0)}),this),d.set(this._outputTypeNumberLabel,"innerHTML",this.i18n.sixLabel),d.set(this._outputLayerNumberLabel,"innerHTML",this.i18n.sevenLabel))):this._showDiv(this._dimensionError,!0)},_setDimensionFieldOrValueAttr:function(e){this.dimensionFieldOrValue=e},_getDimensionFieldOrValueAttr:function(){return this._dimensionFieldOrValue&&(this.dimensionFieldOrValue=this._dimensionFieldOrValue.get("value")),this.dimensionFieldOrValue},_setDimensionFieldAttr:function(e){this.dimensionField=e},_getDimensionFieldAttr:function(){return this._dimensionField&&(this.dimensionField=this._dimensionField.get("value")),this.dimensionField},_setStartFieldOrValueAttr:function(e){this.startFieldOrValue=e},_getStartFieldOrValueAttr:function(){return this._startFieldOrValue&&(this.startFieldOrValue=this._startFieldOrValue.get("value")),this.startFieldOrValue},_setEndFieldOrValueAttr:function(e){this.endFieldOrValue=e},_getEndFieldOrValueAttr:function(){return this._endFieldOrValue&&(this.endFieldOrValue=this._endFieldOrValue.get("value")),this.endFieldOrValue},_setRelativeValueOrDaysBeforeAttr:function(e){this.relativeValueOrDaysBefore=e,this._relativeValueOrDaysBefore.set("value",e)},_getRelativeValueOrDaysBeforeAttr:function(){return this._relativeValueOrDaysBefore&&(this.relativeValueOrDaysBefore=this._relativeValueOrDaysBefore.get("value")),this.relativeValueOrDaysBefore},_setRelativeValueOrDaysAfterAttr:function(e){this.relativeValueOrDaysAfter=e,this._relativeValueOrDaysAfter.set("value",e)},_getRelativeValueOrDaysAfterAttr:function(){return this._relativeValueOrDaysAfter&&(this.relativeValueOrDaysAfter=this._relativeValueOrDays.get("value")),this.relativeValueOrDaysAfter},_setBufferDistanceAttr:function(e){this.bufferDistance=e},_getBufferDistanceAttr:function(){return this._bufferDistance&&(this.bufferDistance=this._bufferDistance.get("value")),this.bufferDistance},_setStatisticsTypeAttr:function(e){this.statisticsType=e},_getStatisticsTypeAttr:function(){return this._statisticsType&&(this.statisticsType=this._statisticsType.get("value")),this.statisticsType},_setPercentileValueAttr:function(e){this.percentileValue=e},_getPercentileValueAttr:function(){return this._percentileValue&&(this.percentileValue=this._percentileValue.get("value")),this.percentileValue},_setUniqueIdFieldAttr:function(e){var t=[this._uniqueIdField,this._dimensionFieldZ,this._dimensionFieldOrValueZ,this._startFieldOrValueZ,this._endFieldOrValueZ,this._bufferDistance],s=[this._dimensionField,this._dimensionFieldOrValue,this._startFieldOrValue,this._endFieldOrValue];if(this._refreshFields(t.concat(s),!0),this.locationLayer){var a,n=[],l=[];if("esri.layers.ArcGISImageServiceLayer"===this.locationLayer.declaredClass)this.locationLayer.hasRasterAttributeTable?a=this.locationLayer._rasterAttributeTableFields:n.push({value:"VALUE",name:"VALUE"});else if(!(a=this.locationLayer.fields))return;a&&i.forEach(a,(function(e){e.type===T.FieldTypes.Integer||e.type===T.FieldTypes.Short||e.type===T.FieldTypes.Double||e.type===T.FieldTypes.long?n.push({value:e.name,name:F.isDefined(e.alias)&&""!==e.alias?e.alias:e.name}):e.type===T.FieldTypes.Date&&l.push({value:e.name,name:F.isDefined(e.alias)&&""!==e.alias?e.alias:e.name})})),n.length>0&&this._refreshFields(t,!1,n),l.length>0&&this._refreshFields(s,!1,l)}},_getUniqueIdFieldAttr:function(){return this._uniqueIdField&&(this.uniqueIdField=this._uniqueIdField.get("value")),this.uniqueIdField},_getResamplingTypeAttr:function(){return this._resamplingType&&(this.resamplingType=this._resamplingType.get("value")),this.resamplingType},_getGenerateFeatureClassAttr:function(){var e=this._aggregateTable.querySelectorAll("[name='outputType']");return e&&e.length>0&&(this.generateFeatureClass=e[1].checked),this.generateFeatureClass},_setGenerateFeatureClassAttr:function(){var e=this._aggregateTable.querySelectorAll("[name='outputType']");e&&e.length>0&&(e[1].checked=this.generateFeatureClass)},_getLayoutAttr:function(){var e=this._aggregateTable.querySelectorAll("[name='layout']");return e&&e.length>0&&(this.layout=e[0].checked?"ROW_WISE":"COLUMN_WISE"),this.layout},_setLayoutAttr:function(){var e=this._aggregateTable.querySelectorAll("[name='layout']");e&&e.length>0&&e[0].checked},_getAcquisitionDefinitionAttr:function(){var e,i,s=this._aggregateTable.querySelectorAll("[name='stdTime']"),a=this._aggregateTable.querySelectorAll("[name='stdZ']"),n=[];return s[0].checked&&(e={dimension:"StdTime"},"singleFieldOrValue"===(i=u("input:checked",this._optionsRow)[0].value)?t.mixin(e,{startFieldOrVal:this._dimensionFieldOrValue.get("value")}):"relativeValue"===i?(t.mixin(e,{startFieldOrVal:this._dimensionField.get("value")}),t.mixin(e,{relValOrDaysBefore:this._daysBefore.get("value")}),t.mixin(e,{relValOrDaysAfter:this._daysAfter.get("value")})):"startEndValue"===i&&(t.mixin(e,{startFieldOrVal:this._startFieldOrValue.get("value")}),t.mixin(e,{endFieldOrVal:this._endFieldOrValue.get("value")})),n.push(e)),a[0].checked&&(e={dimension:"StdZ"},"singleFieldOrValueZ"===(i=u("input:checked",this._optionsRowZ)[0].value)?t.mixin(e,{startFieldOrVal:this._dimensionFieldOrValueZ.get("value")}):"relativeValueZ"===i?(t.mixin(e,{startFieldOrVal:this._dimensionFieldZ.get("value")}),t.mixin(e,{relValOrDaysBefore:this._daysBeforeZ.get("value")}),t.mixin(e,{relValOrDaysAfter:this._daysAfterZ.get("value")})):"startEndValueZ"===i&&(t.mixin(e,{startFieldOrVal:this._startFieldOrValueZ.get("value")}),t.mixin(e,{endFieldOrVal:this._endFieldOrValueZ.get("value")})),n.push(e)),n}});return n("extend-esri")&&t.setObject("dijit.analysis.Sample",N,D),N}));