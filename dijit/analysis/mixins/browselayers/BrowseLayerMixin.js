// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojo/query","../../../../kernel","../../../../request","../../../../lang","../../../../layers/CSVLayer","../../../../arcgis/Portal","../../../../SpatialReference","../../ProjectExtent","dojo/Deferred","../../ItemTypes","../../utils","./configs/AGOLBrowseItem","./configs/EnterpriseBrowseItem","dojo/i18n!../../nls/BrowseLayerMixin"],(function(e,t,i,s,o,r,n,a,l,h,c,d,u,m,y,p,g,f){var b=e([],{tableSupportedTools:["JoinFeatures","SummarizeAttributes","ExtractData","GeocodeLocationsfromTable","CopyToDataStore","AppendData","CalculateField","MergeLayers","DescribeDataset","DetectIncidents"],allowedItemTypes:[],defaultItemTypes:[m.MS,m.FS],availableItemTypeFilters:["layers","featureLayers"],_createBrowseItems:function(e,t,i){var s=e||{},o=s.browseValue||{},r=t||{},n=this.defaultItemTypes.concat(this.get("allowedItemTypes"));if(this.useArcGISComponents)this.setUpItemBrowser(s,r,i).then(function(){this.map&&this._chopExtentAtDateLine(this.map.extent).then(this._projectExtentAndDispatch.bind(this))}.bind(this));else{var a,l=[];n.forEach((function(e){l.push('type:"'+e+'"')})),"browse"===o?((a=this._browsedlg.browseItems.get("query")).custom=this._queryTagsForLivingAtlasBrowseItems(r),this._browsedlg.browseItems.set("extent",this.get("map").extent),this._browsedlg.browseItems.set("query",a),this._browsedlg.show()):(this.showGeoAnalyticsParams&&l.push('type:"'+m.BIGDATA+'"'),(a=this._browseLyrsdlg.browseItems.get("query")).types=l,this._browseLyrsdlg.browseItems.set("query",a),r.geometryTypes?(this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!0,r.geometryTypes.length>0&&(this._browseLyrsdlg.browseItems.plugIn.geometryTypes=r.geometryTypes)):this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,r.layerTypes?(this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0,r.layerTypes.length>0&&(this._browseLyrsdlg.browseItems.plugIn.layerTypes=r.layerTypes)):this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!1,r.customCheck?(this._browseLyrsdlg.browseItems.plugIn.customCheckHandler=r.customCheck.customCheckHandler,this._browseLyrsdlg.browseItems.plugIn.customCheckFailureMessage=r.customCheck.customCheckFailureMessage):this._browseLyrsdlg.browseItems.plugIn.customCheckHandler=void 0,this._browseLyrsdlg.show())}},setUpItemBrowser:function(e,i,s){var o=new u;return window.require(["arcgis-components/wrappers/ItemBrowser","esri/arcgis/Portal"],function(r,a){if(!this.ib){var l=document.createElement("div");!e.isDialog&&document.body.appendChild(l);var h=new a.Portal(this.portalSelf&&this.portalSelf.urlKey&&this.portalSelf.customBaseUrl?location.protocol+"//"+this.portalSelf.urlKey+"."+this.portalSelf.customBaseUrl+"/sharing/rest":(this.portalSelf&&this.portalSelf.portalHostname?location.protocol+"//"+this.portalSelf.portalHostname:this.portalUrl)+"/sharing/rest"),c=this.defaultItemTypes.concat(this.get("allowedItemTypes")),d=function(){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),this._resetSelectBox(s),!e.isDialog&&this._removeDOMfromBody(l)},u=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),t[0]&&t[0].type===m.RFT?this.onSelectRFTTool.bind(this)(t[0],h):t[0]&&t[0].type===m.DLPK?this.onSelectDLPKTool.bind(this)(t[0],h):this.onBrowseItemSelect.bind(this)(t[0],h,s),!e.isDialog&&this._removeDOMfromBody(l)},y=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),this.onSelectGPTool.bind(this)(t),!e.isDialog&&this._removeDOMfromBody(l)},f=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),this.onEditRFTTool.bind(this)(t,h),!e.isDialog&&this._removeDOMfromBody(l)},b=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),this.onBrowseItemSelect.bind(this)(t,h,s),!e.isDialog&&this._removeDOMfromBody(l)},w=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),t&&t.type===m.RFT?this.onEditRFTTool.bind(this)(t,h):this.onBrowseItemSelect.bind(this)(t,h,s,!0),!e.isDialog&&this._removeDOMfromBody(l)};this.tableSupportedTools.indexOf(this.helpFileName)>-1&&(c=c.concat([this.showGeoAnalyticsParams?m.TABLE:m.BTABLE])),h.signIn().then(function(){this._fetchGroupForRFT(h).then(function(s){c.indexOf(m.IS)>-1?this.availableItemTypeFilters=["layers","featureLayers","mapImageLayers","imageryLayers"]:-1===c.indexOf(m.GPSERVICE)&&-1===c.indexOf(m.RFT)&&-1===c.indexOf(m.FILE)&&(this.availableItemTypeFilters=this.availableItemTypeFilters.concat(["layers","featureLayers"])),this.tableSupportedTools.indexOf(this.helpFileName)>-1&&(this.availableItemTypeFilters=this.availableItemTypeFilters.concat(["tables"]));var a={allowedItemTypes:this.showGeoAnalyticsParams?[m.BIGDATA].concat(c):c,availableItemTypeFilters:this.showGeoAnalyticsParams?this.availableItemTypeFilters.concat(["bigDataFileShares"]):this.availableItemTypeFilters,customQueryTags:i,addQueryParameters:e.addQueryParameters,portal:h,isPortal:this.isSingleTenant,onSelectSubLayer:b.bind(this),onActionSubLayer:w.bind(this),onSelectGPTool:y.bind(this),onEditRFT:f.bind(this),rftGroupId:s,disableLAAL:e.disableLAAL,disableBoundary:e.disableBoundary,title:e.title,disabledSubResources:this._getDisableResources(e.disabledSubResources),showRFTSystemSection:null==e.showRFTSystemSection||e.showRFTSystemSection,showRFTEditCustomAction:null==e.showRFTEditCustomAction||e.showRFTEditCustomAction},T=t.mixin(r.initialState.settings.config,this.isSingleTenant?g.getConfig(a):p.getConfig(a));a.allowedItemTypes.indexOf(m.RFT)>-1&&!this.isSingleTenant&&(T.addQueryParameters=function(e){return"all"===e.parameters.section?"-owner: (esri_*)":""}),this.ib=new r.ItemBrowserWrapper(l,{apiVersion:3,portal:h,request:n,initialState:t.mixin(r.initialState,{settings:t.mixin(r.initialState.settings,{config:t.mixin(T,{onBack:d.bind(this),onSelect:u.bind(this)})}),ui:t.mixin(r.initialState.ui,{expanded:t.mixin(r.initialState.ui.expanded,{filters:!0})})}),parameters:t.mixin(r.initialState.parameters,{section:"myContent",filter:t.mixin(r.initialState.parameters.filter,{searchMapArea:!1})})}),e.isDialog&&this._createDialog(l,h),o.resolve()}.bind(this))}.bind(this))}}.bind(this)),o},_queryTagsForLivingAtlasBrowseItems:function(e){var t=e&&e.tags;if(t&&0!==t.length)return 1===t.length?['tags:"'+t[0]+'"']:(o=[],t.forEach((function(e){o.push('tags:"'+e+'"')})),o)},onBrowseItemSelect:function(e,t,i,s){var o=this._getPortalItem(e,t),r={selection:o,dialog:this._browseLyrsdlg||this._browsedlg};!e.url||y.isHostedService(e.url)||this.isSingleTenant||o.selectedLayer instanceof l?this._handleBrowseItemsSelect(r,s):this._getProxyServiceInfo(e).then(function(){!!a.isDefined(e.analysisProxyCheck)&&"failure"===e.analysisProxyCheck?this._resetSelectBox(i):this._handleBrowseItemsSelect(r,s)}.bind(this),function(){this._resetSelectBox(i)}.bind(this))},onSelectGPTool:function(e){e.resource.url=e.url,this._handleSelectGpTool(e.resource)},onSelectRFTTool:function(e,t){this._handleSelectRFTTool(this._getPortalItem(e,t))},onSelectDLPKTool:function(e,t){this._handleSelectDLPKTool(this._getPortalItem(e,t))},onEditRFTTool:function(e,t){this._handleEditRFTTool(this._getPortalItem(e,t))},_getPortalItem:function(e,i){var s;return e.resource&&e.item?((s=new h.PortalItem(t.mixin(e.item,{portal:i}))).selectedLayer=e.resource,s.selectedLayer.url=e.url):(s=new h.PortalItem(t.mixin(e,{portal:i})),e.type&&[m.CSV,m.XLS].indexOf(e.type)>-1&&(s.selectedLayer=s)),s},_createDialog:function(e,t){window.require(["dijit/Dialog","esri/dijit/analysis/mixins/browselayers/configs/Common"],function(t,i){this.itemBrowserDialog||(this.itemBrowserDialog=new t({style:"width: 900px; height:900px; overflow: auto",id:"itemBrowserDialog",closable:!1,title:f.customAnalysisLayerTitle})),this.itemBrowserDialog.set("content",e),this.itemBrowserDialog.show()}.bind(this))},_closeDialog:function(){this.itemBrowserDialog.hide(),this.itemBrowserDialog.destroy(),delete this.itemBrowserDialog,delete this.ib},_setAllowedItemTypesAttr:function(e){this.allowedItemTypes=e},_setAvailableItemTypeFiltersAttr:function(e){this.availableItemTypeFilters=e},_getDisableResources:function(e){var t={};return e&&e.length&&e.forEach((function(e){e&&e.url&&(t[e.url]=!0)}),this),t},_projectExtentAndDispatch:function(e){this.sr||(this.sr=new c(4326)),d(e,this.sr,function(e){var t=e[0];this._dispatchExtentToItemBrowser(t)}.bind(this),function(e){console.error(e)}.bind(this))},_chopExtentAtDateLine:function(e){var t=new u;return window.esri.geometry.normalizeCentralMeridian([e],null,(function(i){if(i[0].rings){var s=new window.esri.geometry.Polygon(e.spatialReference).addRing(i[0].rings[0]).getExtent(),o=new window.esri.geometry.Polygon(e.spatialReference).addRing(i[0].rings[1]).getExtent();t.resolve(s.getWidth()>o.getWidth()?s:o)}else t.resolve(i[0])}),(function(e){t.reject(e)})),t},_dispatchExtentToItemBrowser:function(e){window.require(["arcgis-components/wrappers/ItemBrowser"],function(t){this.ib.dispatch(t.updateExtent({minx:e.xmin,miny:e.ymin,maxx:e.xmax,maxy:e.ymax}))}.bind(this))},_fetchGroupForRFT:function(e){var t=new u;return-1===this.allowedItemTypes.indexOf(m.RFT)&&t.resolve(),this._systemRFTsGroup&&t.resolve(this._systemRFTsGroup),y.fetchGroupForRFT(e).then(function(e){this._systemRFTsGroup=e,t.resolve(e)}.bind(this)),t},_removeDOMfromBody:function(e){setTimeout((function(){document.body.removeChild(e)}),300),delete this.ib},_resetSelectBox:function(e){e&&e.reset()},_getProxyServiceInfo:function(e){var t,s,o,l=new u;a.isDefined(e)&&a.isDefined(e.url)||l.reject({error:"mapLayer is not defined"}),t=e.url+(e.url.indexOf("?")>-1?"&":"?")+"f=json";var h=r.id.findCredential(e.url);return s=e.url,this.proxyCheckedServers||(this.proxyCheckedServers=[]),i.some(this.proxyCheckedServers,(function(t){if(o=s.substring(0,s.indexOf("/",9)),t.server===o)return e.analysisProxyCheck=t.check,!0}),this)?l.resolve({}):(h&&h.token&&(t+="&token="+h.token),(l=n({url:t,content:null},{useProxy:!0})).then(function(){e.analysisProxyCheck="success",this.proxyCheckedServers.push({server:s.substring(0,s.indexOf("/",9)),check:"success"})}.bind(this),function(){e.analysisProxyCheck="failure",this.proxyCheckedServers.push({server:s.substring(0,s.indexOf("/",9)),check:"failure"})}.bind(this))),l.promise}});return s("extend-esri")&&t.setObject("dijit.analysis.mixins.browselayers.BrowseLayerMixin",b,r),b}));