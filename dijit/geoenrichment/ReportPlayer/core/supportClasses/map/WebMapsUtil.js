// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/Deferred","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/when","esri/kernel","esri/arcgis/utils","esri/geometry/Extent","esri/request","esri/dijit/geoenrichment/utils/UrlUtil","./UrlToItemUtil"],(function(e,t,i,r,a,n,u,l,o,s){var c={};o.isPageRunOnWebService()||(a.id.getCredential=function(){var e=new t;return e.reject(new Error("Can't get credentials")),e});var f={_itemsCache:{},_siCache:{},loadItem:function(t){return this._itemsCache[t]||(this._itemsCache[t]=n.getItem(t)),r(this._itemsCache[t],(function(t){return t&&e.clone(t)}))},loadServiceInfo:function(e,t){return this._siCache[e]||(this._siCache[e]=t({url:e,content:{f:"json"}})),this._siCache[e]}};return c.getItem=function(e){return f.loadItem(e)},c.isWebMapType=function(e){return e&&"Web Map"===e.type},c.createMap=function(e,t,i){if(i=i||{},e&&e.item)return r(c.isWebMapType(e.item)&&i.additionalLayerInfos&&c._addAdditionalLayerInfosToOperationalLayers(e.itemData.operationalLayers,i.additionalLayerInfos,i.requestFunc),(function(){return r(!c.isWebMapType(e.item)&&c.createItemDataForNonWebMapItem(e,{defaultBasemapId:i.defaultBasemapId,additionalLayerInfos:i.additionalLayerInfos}),(function(){return n.createMap(e,t,{usePopupManager:!0,mapOptions:i.mapOptions||{}})}))}))},c.createItemDataForNonWebMapItem=function(t,i){i=i||{};var a=t.item,n=t.itemData;function u(){return c.executeItemUrl(a,i.requestFunc)}function l(e){return t.itemData={baseMap:null,operationalLayers:e},r(i.additionalLayerInfos&&c._addAdditionalLayerInfosToOperationalLayers(e,i.additionalLayerInfos,i.requestFunc),(function(){return r(!1!==i.defaultBasemapId&&c.provideDefaultBaseMapForItemData(t.itemData,i),(function(){return t}))}))}function s(e,t){return-1!==e.indexOf(t)?e.substr(e.lastIndexOf(t)+t.length,e.length):null}function f(e,t){var i=e.id;return{url:o.combine(a.url,i),capabilities:t.capabilities||"Query",id:t.idPrefix+i,visibility:t.visibility||e.defaultVisibility,mode:1,title:e.title||e.name,description:e.description}}if("Feature Service"===a.type){var p=s(a.url,"FeatureServer/");return u().then((function(e){var t=[],i=p&&function(e,t){var i;return e.layers.some((function(e){return t==e.id&&(i=e),t==e.id})),i}(e,p);if(i)t.push(f(i,{capabilities:e.capabilities,idPrefix:"featureServiceLayer_",visibility:!0}));else for(var r=0;r<e.layers.length;r++)t.unshift(f(e.layers[r],{capabilities:e.capabilities,idPrefix:"featureServiceLayer_"}));return l(t)}))}if("Map Service"===a.type){p=s(a.url,"MapServer/");return u().then((function(t){var i=p&&t.layers[p]?f(t.layers[p],{capabilities:t.capabilities,idPrefix:"mapServiceLayer_",visibility:!0}):{url:a.url,id:"mapServiceLayer01",visibility:!0,title:t.title||t.name};return l([e.mixin(i,{opacity:1},n)])}))}return"Image Service"===a.type?u().then((function(t){return l([e.mixin({url:a.url,id:"imageServiceLayer01",visibility:!0,opacity:1,title:t.title||t.name},n)])})):"Vector Tile Service"===a.type?u().then((function(t){return l([e.mixin({url:a.url,id:"vectorTileServiceLayer01",visibility:!0,opacity:1,title:t.title||t.name,styleUrl:o.combineMulti([a.url,t.defaultStyles,"root.json"]),type:"VectorTileLayer",layerType:"VectorTileLayer"},n)])})):"WMSServer"===a.type?u().then((function(t){return l([e.mixin({url:a.url,id:"wmsLayer01",visibility:!0,opacity:1,title:t.title||t.name},n)])})):"WMTS"===a.type?u().then((function(t){return l([e.mixin({url:a.url,id:"wmtsLayer01",visibility:!0,opacity:1,title:t.title||t.name},n)])})):"WFS"===a.type?u().then((function(t){return l([e.mixin({url:a.url,id:"wfsLayer01",visibility:!0,opacity:1,title:t.title||t.name},n)])})):"KML"===a.type?(o.registerCORS(a.url),l([e.mixin({url:a.url,id:"kmlLayer01",visibility:!0,opacity:1,title:"KML Layer",type:"KML"},n)])):void 0},c.executeItemUrl=function(e,t){var i;return e.url=(i=e.url,["FeatureServer","MapServer","ImageServer"].some((function(e){if(-1!==i.indexOf(e))return i=i.substr(0,i.lastIndexOf(e)+e.length),!0})),i),t=t||l,o.registerCORS(e.url),f.loadServiceInfo(e.url,t).then((function(t){return r(function(e,t){if(!e.extent){var i=t.initialExtent||t.fullExtent||t.extent;!i||i instanceof u||(i=new u(i)),e.extent=i}}(e,t),(function(){return t}))}))},c.provideDefaultBaseMapForItemData=function(e,t){var i;if(t=t||{},!e.baseMap)return r((i={title:"My basemap",baseMapLayers:[{id:"basemapLayer01",opacity:t.hideBasemap?0:1,visibility:!t.hideBasemap,url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]},t.defaultBasemapId?c.getItem(t.defaultBasemapId).then((function(e){return e&&e.itemData&&e.itemData.baseMap||i})):i),(function(t){return e.baseMap=t,e}))},c._addAdditionalLayerInfosToOperationalLayers=function(e,t,r){return i(t.map((function(e,t){return/Server$/.test(e.url)?c.createItemDataForNonWebMapItem({item:s.tryCreateItemFromServerUrl(e.url)},{requestFunc:r}).then((function(e){return e.itemData.operationalLayers})):[{url:e.url,id:"additionalLayer"+t,visibility:!0,opacity:1}]}))).then((function(t){t.forEach((function(t){t.forEach((function(t){e.push(t)}))}))}))},c}));
