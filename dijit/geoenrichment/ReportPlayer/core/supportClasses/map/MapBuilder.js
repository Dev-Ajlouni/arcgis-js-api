// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","dojo/dom-construct","dojo/dom-geometry","esri/graphic","esri/arcgis/utils","esri/graphicsUtils","esri/dijit/HomeButton","./layers/MapContentBuilder","./legend/LegendBuilder","./MapLoadTracker","./StaticMap","./WebMapsUtil","./Popup","./Projector","./mobile/MobilePanUtil","../../../dataProvider/supportClasses/data/AreaDataUtil","esri/dijit/geoenrichment/utils/DataUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/ImageUtil","esri/dijit/geoenrichment/utils/UrlUtil","esri/dijit/geoenrichment/ReportPlayer/_devConfig"],(function(e,t,a,n,r,o,i,s,l,c,d,u,m,p,f,I,h,g,_,y,x,M,v,b,j){var C=e(null,{_mapInfos:null,_mapDivId:0,_mapImageInfos:null,renderMapsFromCalculators:!1,constructor:function(e){t.mixin(this,e),this.reset()},setArcgisUrl:function(e){e&&(l.arcgisUrl=b.combine(e,"/sharing/rest/content/items"))},reset:function(){this._mapInfos={},this._mapImageInfos=null},collectAreaMaps:function(e){var t=[];e=e||0;var a=this._mapInfos[e];for(var n in a){var r=a[n],o=r.node;if(o.parentNode){var s=i.position(o);t.push({areaIndex:e,node:o,x:s.x,y:s.y,position:-1,map:r.map,legend:r.legend,itemId:r.itemId})}}return t.sort((function(e,t){return e.x-t.x})),t.sort((function(e,t){return e.y-t.y})),t.forEach((function(e,t){e.position=t})),t},collectAllAreasMaps:function(){var e=[];for(var t in this._mapInfos)e=e.concat(this.collectAreaMaps(t));return e},setFallbackMapImageInfos:function(e){e?(this._mapImageInfos={},e.forEach((function(e){var t=e.areaIndex||0;(this._mapImageInfos[t]=this._mapImageInfos[t]||{})[e.itemId]=e}),this)):this._mapImageInfos=null},createMap:function(e,t){return t.areaIndex=t.areaIndex||0,r(this._doCreateMap(e,t),(function(e){return t.waitForLoad?e&&r(p.waitForLoad(e.map),(function(){return e})):e}))},_doCreateMap:function(e,t){var a=this;if(this.renderMapsFromCalculators&&t.calculatorFieldName){var o=y.getAreaDataValue({fieldName:t.calculatorFieldName,fieldData:t.fieldData,featureIndex:t.areaIndex});if(o){var i=-1===o.indexOf("mapOptions")?v.base64DataToDataURL(o):"data:application/json;base64,"+x.base64FromJson(o);return this._createStaticMap({url:i},e,t)}}return r(I.getItem(t.webMapId),(function(r){if(!r||j.emulateErrors.getMapItemError)return(new n).reject(new Error("Can't load an item or the item is incorrect."));var o=new n;try{a._createMapFromItem(r,e,t).then(o.resolve,o.reject)}catch(e){o.reject(e),console.log(e)}return o.promise})).otherwise(this._createFallbackStaticMap.bind(this,t,e))},_createMapFromItem:function(e,t,a){var i=this,s=M.isMobileDevice();return I.createMap(e,t,{defaultBasemapId:a.defaultBasemapId,additionalLayerInfos:a.additionalLayerInfos,mapOptions:{extent:a.extent||c.graphicsExtent(a.features).expand(a.expandFactor||1.5),sliderPosition:!1===a.sliderPosition?"none":a.sliderPosition||"top-right",infoWindow:new h({getPlayerZoomScale:function(){return i.getPlayerZoomScale(t)}},o.create("div")),isMapNavigation:!s}}).then((function(e){var o=e&&e.map;return o?r(i._setInitialExtent(o,a),(function(){return r(u.addLayersToMap(o,{features:a.features,featureIndexToAreaIndexMap:a.featureIndexToAreaIndexMap,analysisAreas:a.analysisAreas,locatorPointsControllers:a.locatorPointsControllers,stdPolygonsControllers:a.stdPolygonsControllers,thisAreasHighlightController:a.thisAreasHighlightController,geClient:a.geClient,countryID:a.countryID,hierarchy:a.hierarchy,additionalLayerInfos:a.additionalLayerInfos,calculatorFieldName:a.calculatorFieldName,pinSymbolJson:a.pinSymbolJson,areaSymbolJsons:a.areaSymbolJsons,areaSymbolRamp:a.areaSymbolRamp,attachmentsStore:a.attachmentsStore}),(function(){s&&_.setUpMapPan(o,a.onPanContainer),void 0===t.__mapDivId&&(t.__mapDivId=i._mapDivId++);var e={node:t,map:o,itemId:a.webMapId,legend:null};m.createLegend(o,t,a.legendController,{onCreated:function(t){e.legend=t},onDestroyed:function(){delete e.legend}});var n=new d({map:o}).placeAt(t);return n.startup(),n.own(o.on("before-unload",(function(){n.destroy()}))),(i._mapInfos[a.areaIndex]=i._mapInfos[a.areaIndex]||{})[t.__mapDivId]=e,e}))})):(new n).reject(new Error("Can't create a map."))}))},_setInitialExtent:function(e,t){return r(t.extent||a(t.features.map((function(t){return g.needProject(t.geometry,e)?r(g.projectGeometries(t.geometry,e),(function(e){return new s(e)})):t}))).then((function(e){return c.graphicsExtent(e).expand(t.expandFactor||1.5)})),(function(t){return g.needProject(t,e)?r(g.projectGeometries(t,e),(function(t){return e.setExtent(t)})):e.setExtent(t)}))},_createFallbackStaticMap:function(e,t){var a=this._mapImageInfos&&this._mapImageInfos[e.areaIndex]&&this._mapImageInfos[e.areaIndex][e.webMapId];return this._createStaticMap(a,t,e)},_createStaticMap:function(e,t,a){var n=e&&new f(e,t);return n&&n.load().then((function(){return n.loaded?{node:t,map:n,itemId:a.webMapId,legend:null}:null}))},getPlayerZoomScale:function(e){}});return C.EXPAND_FACTOR=1.5,C}));
