// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/lang","../../ThemeCalculator","../../ChartSorting","../../ChartLineStyles","../../../../supportClasses/conditionalStyling/ConditionalStyleUtil","../utils/TooltipInfoBuilder","./_ComparisonUtil","./_AxisBuilder","./_PointLabelUtil","./_StatsBuilder","esri/dijit/geoenrichment/utils/ColorUtil"],(function(e,i,t,a,n,r,s,o,l,u,c){var h=function(e,i){return{color:c.getColorWithAlpha(i.outlineColor||e,i.outlineOpacity),width:i.outlineThickness,style:a.toGFXValue(i.outlineStyle||a.SOLID)}};return{calcSeriesColumnBar:function(a){var S=a.chart,d=a.visualProperties,m=a.seriesItems,p=1===m.length,I=a.seriesItemsWithComparison||m,g=a.chartType,C=a.comparisonInfo,f=a.themeSettings,v=a.viewModel,y=1===I.length&&a.sorting,x=I.length>1&&d.renderColumnBarsInOppositeDirections,b=[],V=new u({visualProperties:d,seriesItems:I,viewModel:v,currentFeatureIndex:a.currentFeatureIndex,isMultiFeatureChart:a.isMultiFeatureChart,excludedSeriesHash:a.excludedSeriesHash,comparisonFeatureAttributes:a.comparisonFeatureAttributes,chartType:g});l.createPointToLabelMap(S);var k={};I.forEach((function(e,o){if(e.points.length){var u={name:e.label,data:[],isComparisonSeries:e.isComparisonSeries,params:{plot:e.isComparisonSeries&&s.getComparisonPlotName(g,C)||void 0}},m=V.getStatisticsForSeriesAt(o);i.provideMissingIconsForPoints(e.points,g);var A=[];e.points.forEach((function(t,s){var S,y=m.values[s],b=y.value,V=b||0;if(d.conditionalStyling){var F=n.getConditionalStyle(y.isBenchmarked?y.ownValue:V,d.conditionalStyling);S=F&&F.backgroundColor}S=S||i.calcColorForPoint({point:t,seriesItem:e,pointIndex:s,seriesIndex:o,numSeries:p?1:I.length,chartType:g,themeSettings:f,isComparisonSeries:e.isComparisonSeries,comparisonInfo:C,isMultiFeature:a.isMultiFeatureChart});var P,w,M=h(S,d),T=S;S=d.columnBarOpacity<1?c.getColorWithAlpha(S,d.columnBarOpacity):S,t.hidden&&(P=S,S=T="transparent"),t.hidden&&(w=M.color,M.color="transparent");var B=s+1,L={x:B,y:V*(x&&o>=I.length/2?-1:1),originalValue:b,isUnavailableData:isNaN(b),valueProp:"y",unsortedIndex:s,originalIndex:t.originalIndex||s,seriesIndex:o,name:l.getPointLabel(t,v),valuesSumsInSeries:m.absSumInSeries,point:t,fill:S,icon:i.calcIconForPoint(t,T,g),bgIcon:i.calcBackgroundIconForPoint(t,g,f,d),stroke:{color:M.color,width:M.width,style:M.style},unhiddenFillColor:P,unhiddenLineColor:w,isBenchmarked:y.isBenchmarked,unbenchmarkedValue:y.ownValue};if(d.isStacked){var N=d.showValuesAsWeightInStack?m.stackValuesAsWeighedPercents:m.stackValues;L.stackValues=N&&N[s]}d.showValuesAsWeightInStack?L.y=m.weightsInStack?100*m.weightsInStack[s]:0:d.yAxis.showValuesAsWeightsInSeries&&(L.y/=m.absSumInSeries/100);var W=l.getPointLabel(I[0].points[s]||t,v),Y=r.getTooltipInfo({yValue:b,pointLabel:W,seriesLabel:e.label,isSinglePointInSeries:1===e.points.length,minInSeriesValue:m.minInSeries,maxInSeriesValue:m.maxInSeries,sumInSeriesValue:m.sumInSeries,absSumInSeriesValue:m.absSumInSeries,avgInSeriesValue:m.avgInSeries,weightInStack:m.weightsInStack&&m.weightsInStack[s],minInAreasValue:m.minInSeries,maxInAreasValue:m.maxInSeries,sumInAreasValue:m.sumInSeries,absSumInAreasValue:m.absSumInSeries,avgInAreasValue:m.avgInSeries,visualProperties:d,chartType:g,isMultiFeature:a.isMultiFeatureChart,conditionalStyling:d.conditionalStyling,fieldInfo:t.fieldInfo,isThisAreaSpecific:C&&!a.isMultiFeatureChart?!e.isComparisonSeries:void 0,isThisAreaSingleSeries:p,decimals:t.value&&t.value.decimals,fill:L.fill,stroke:L.stroke.width>0?L.stroke.color:void 0,isBenchmarked:y.isBenchmarked,unbenchmarkedValue:y.ownValue,chartContainer:a.chartContainer,viewModel:v,theme:a.theme,themeSettings:f,dataDrillingPanelInfo:a.dataDrillingPanelInfo,pointName:a.isMultiFeatureChart?e.label:W,seriesName:t.originalSeriesName||e.label,areaName:t.areaName,featureIndex:y.featureIndex,isComparisonPoint:t.isComparisonPoint,comparisonFeatureAttribute:t.comparisonFeatureAttribute}),D=k[B]=k[B]||[];a.excludedSeriesHash[e.label]||(D.push(Y),A.push(Y)),Y.getGroup=function(){return a.isMultiFeatureChart?A:D},L.tooltip=Y,u.data.push(L)})),y&&y!==t.NONE&&(u.data.sort((function(e,i){return(e.y-i.y)*(y===t.DESC?-1:1)})),u.data.forEach((function(e,i){var t=i+1;e.x=t}))),u.data.forEach((function(e){l.updatePointIndexToLabelMap(S,e.x,o,e.point,v)})),b.push(u)}}),this);var A=V.getTotalStats();return o.prettifyYAxis(A.minYValue,A.maxYValue,S,d,g,f,v,b),a.plotStats&&(e.mixin(a.plotStats,A),a.plotStats.pointIndexToTooltipsHash=k),b},prettifyColumnBarYAxis:function(e){o.prettifyYAxis(e.totalStat.minYValue,e.totalStat.maxYValue,e.chart,e.visualProperties,e.chartType,e.themeSettings,e.viewModel,e.chartSeries,!0,e.chartSize),e.chart.dirty=!0}}}));
