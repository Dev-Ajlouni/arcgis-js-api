// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","./supportClasses/areas/AnalysisAreaJsonUtil","./supportClasses/areas/AnalysisAreaUtil","./supportClasses/PortalManager","../core/infographics/InfographicTypes","../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil","esri/dijit/geoenrichment/ReportPlayer/countryConfig","esri/dijit/geoenrichment/ReportPlayer/_devConfig"],(function(e,r,t,a,o,n,s,i,l,c,p,u,m){var f,g,h,d,v,A,y;function b(){var r=new a;return e(["./supportClasses/attachments/AttachmentsStoreSerializer","./supportClasses/GEUtil","../core/supportClasses/templateJsonUtils/TemplateJsonSerializer","../core/supportClasses/templateJsonUtils/TemplateJsonAnalyzer","../core/infographics/utils/InfographicJsonUtil","../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider","../core/infographics/InfographicTypes","./commands/mapToImage/MapToURLUtil","esri/dijit/geoenrichment/utils/ProjectionUtil"],(function(e,t,a,o,n,s,i,l,p){f=e,g=t,h=a,o,d=n,v=s,c=i,A=l,y=p,r.resolve()})),r.promise}return r(null,{reportDataToJson:function(e,r){var a=this;r=r||{};var n=!1;return p.processTemplateFieldInfos(e.templateJson,(function(e){e.isInfographic&&e.infographicJson.type===c.ATTACHMENTS&&(n=!0)})),b().then((function(){return o(null,(function(){return o(e.attachmentsStore&&f.getAttachmentsStoreJson(e.attachmentsStore,{numAreas:e.analysisAreas.length,saveImages:n}),(function(o){var n=t.mixin({},e.config);!1!==r.forceFixedDataMode&&delete n.geoenrichmentUrl;var i={isMultiFeature:e.isMultiFeature,reportTitle:e.reportTitle,templateJson:h.serialize(e.templateJson),reportObject:a._prepareReportObjectJson(e.reportObject),fieldData:e.fieldData,analysisAreas:s.areasToJson(e.analysisAreas),combinedAreasInfo:e.combinedAreasInfo&&s.combinedAreasInfoToJson(e.combinedAreasInfo),reverseAnalysisAreasOnMap:e.reverseAnalysisAreasOnMap,infographicOptions:e.infographicOptions&&e.infographicOptions.toJson(),attachmentsStore:o,templateVariableProvider:e.templateVariableProvider&&e.templateVariableProvider.toJson(),config:n,countryConfig:u.toJson(),mapImageInfos:r.mapImageInfos,customLogo:e.customLogo};return m.logData&&(console.log("_SerializationSupport.js => reportDataJson"),console.log(i)),i}))}))}))},_prepareReportObjectJson:function(e){var r={};for(var t in e)e[t]&&"object"!=typeof e[t]&&(r[t]=e[t]);return r},_enrichInfographicVariables:function(e,r){var t=e.infographicOptions;return o(t.getOptions().getItems(t.countryID),(function(){var o=[];return r.forEach((function(r){r.isInfographic&&r.variables&&e.analysisAreas.forEach((function(e,n){t.setCurrentAnalysisAreaIndex(n);var s=new a,i=t.createGeoenrichment({currentFeatureIndex:n});i.onDone=function(){s.resolve()},i.country=t.countryID;var l=c.supportsComparison(r.type);i.setGeoLevels(l?d.getSubLevels(r):null,l?d.getHighestLevel(r):null),i.setVariables(r.variables),i.setStudyArea(t.studyArea),o.push(s.promise)}))})),n(o)}))},reportDataFromJson:function(e){var r=this;return b().then((function(){var t=e.fieldData;t.featureData&&(t.areaData=t.featureData.map((function(e){return{mainCalculator:{data:e}}})),delete t.featureData);var a={isMultiFeature:e.isMultiFeature,reportTitle:e.reportTitle,templateJson:h.deserialize(e.templateJson),reportObject:e.reportObject,fieldData:t,analysisAreas:s.areasFromJson(e.analysisAreas),combinedAreasInfo:e.combinedAreasInfo&&s.combinedAreasInfoFromJson(e.combinedAreasInfo)||{},reverseAnalysisAreasOnMap:e.reverseAnalysisAreasOnMap,infographicOptions:e.infographicOptions&&r._infographicOptionsProvider.getInfographicOptionsFromJson(e.infographicOptions),attachmentsStore:e.attachmentsStore&&f.getAttachmentsStoreFromJson(e.attachmentsStore),templateVariableProvider:e.templateVariableProvider&&new v(e.templateVariableProvider),config:e.config||{},mapImageInfos:e.mapImageInfos,customLogo:e.customLogo};i.populateCombinedAreasInfo(a.combinedAreasInfo,a.analysisAreas),g.setGeoenrichmentUrl(null);var n=!1;return a.config.geometryServiceUrl?y.setGeometryServiceUrl(a.config.geometryServiceUrl):n=!0,a.config.printMapTaskUrl?A.setPrintMapTaskUrl(a.config.printMapTaskUrl):n=!0,u.fromJson(e.countryConfig),o(n&&l.tryConfigureServicesFromAGOLPublic()).then((function(){return a}))}))}})}));