// COPYRIGHT Â© 2020 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/utils/ImageUtil","./supportClasses/ReportDataProcessor","./supportClasses/tasks/parsers/DataXMLParser","./supportClasses/areas/AnalysisAreaUtil","./supportClasses/areas/AnalysisAreaJsonUtil","./supportClasses/areas/AreasPreprocessor","./supportClasses/GEUtil","../core/supportClasses/ReportTemplateTypes","../core/conversion/PortalToEditorConverter","../core/supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil","./supportClasses/attachments/AttachmentsStoreSerializer","../core/supportClasses/templateJsonUtils/TemplateJsonSerializer","../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider","../core/conversion/portalToEditorUtils/metadata/MetadataFromDataBuilder","../countryConfig"],(function(e,a,t,r,s,n,o,i,l,u,p,c,m,f,d,h,A,v){return e(null,{reportDataToServerData:function(e){return null},reportDataFromServerData:function(e,g){var y=this;v.reset();var C,D=e.reportItem.resources;if(!Array.isArray(D)){var E=D;for(var b in D=[],E)D.push({name:b,data:E[b]})}D.forEach((function(e){"theme.css"===e.name&&(e.name="theme.css.txt")}));var R=D.filter((function(e){return"report.xml"===e.name}))[0],S=D.filter((function(e){return"data.xml"===e.name}))[0];var T=function(){var t=/.*\.(png|jpg|jpeg)$/i,s=/.*\.(json)$/i,o={},i={};D.forEach((function(e){if(t.test(e.name)&&(o[e.name]=e.data,"logo.png"===e.name&&(C=r.base64DataToDataURL(e.data,"image/png"))),s.test(e.name)){if(-1!==e.data.indexOf("mapOptions")&&-1!==e.data.indexOf("ComparisonResultsLayer.")){var a=JSON.parse(e.data);a.operationalLayers.filter((function(e){return e.featureCollection&&e.featureCollection.layers&&(e.featureCollection.layers=e.featureCollection.layers.filter((function(e){return!e.id||0!==e.id.indexOf("ComparisonResultsLayer.")}))),!0})),e.data=JSON.stringify(a)}i[e.name]=e.data}}));var l={},u=R.data.match(/<section[^<>]*query=".+?".*?>/g);u&&u.forEach((function(e){var a=e.replace(/.*?query="/,"");a=a.replace(/".*/,""),l[a]=1}));var p={},c=n.parse(S.data,(function(e,a,t){var r=i[a];return r?(p[t]=1,r):o[a]||a}));return function(e,a){if(D.some((function(e){return"metadata.xml"===e.name})))return;D.push({name:"metadata.xml",data:A.recoverMetadataFromAreaData(e.areaData,a)})}(c,{map:p,locator:l}),function(t,s){e.sites=[];var n={};t.areaData.forEach((function(t){var r=t.headers&&t.headers.data||{},s={name:r.SITE_NAME||r.STORE_NAME||r.AREA_DESC,shortName:r.AREA_DESC,address:r.STORE_ADDR,description:r.AREA_DESC2,latitude:r.STORE_LAT,longitude:r.STORE_LONG},o=r.STORE_ID||"default";"number"!=typeof n[o]&&(n[o]=e.sites.length,e.sites.push(a.mixin({areas:[]},s))),e.sites[n[o]].areas.push(a.mixin({feature:{attributes:{}}},s))})),t.reportInfo.sites&&t.reportInfo.sites.forEach((function(a,t){var n=e.sites[t];n.attributes=a.attributes,n.notes=a.notes,n.images=a.images,n.images&&n.images.forEach((function(e){function a(e){var a=s[e];return a&&r.base64DataToDataURL(a,"image/png")}e.url=a(e.url),e.thumbnail=a(e.thumbnail)}))}))}(c,o),c}(),I=new h;return t(function(e){var a=R.data.indexOf("<section"),r={isGraphicReport:R.data.indexOf("<table")<a,isMultiFeature:!1,defaultComparisonZoom:null,type:p.STANDARD,portalJson:{files:D}};return t(c.provideEditorJson(r,{variableProvider:e}),(function(){return r.templateJson=d.deserialize(r.templateJson),r.isMultiFeature=m.hasMultiFeatureSections(r.templateJson),delete r.portalJson,r}))}(I),(function(a){o.parseSites(e);var r=i.areasFromJson(e.analysisAreas),n=e.combinedAreasInfo&&i.combinedAreasInfoFromJson(e.combinedAreasInfo)||{},p=e.attachmentsProvider&&f.getAttachmentsStoreFromJson(e.attachmentsProvider),c=y._infographicOptionsProvider.getInfographicOptions({analysisAreas:r}),m={isMultiFeature:a.isMultiFeature&&r.length>1,reportTitle:null,templateJson:a.templateJson,reportObject:a,fieldData:{specialTradeAreaCalculatorName:null,runReportTaskIDs:null,metadata:{},areaData:[],errors:[],reportInfo:null},analysisAreas:r,combinedAreasInfo:n,reverseAnalysisAreasOnMap:!0,infographicOptions:c,attachmentsStore:p,templateVariableProvider:I,customLogo:C,config:{}};return o.populateCombinedAreasInfo(m.combinedAreasInfo,m.analysisAreas),l.provideAreasIndexes(m),u.setGeoenrichmentUrl(null),g&&g.forEach((function(e){switch(e){case"Maps":u.addCapability("FormatInfographicsMaps");break;case"ImageUrls":u.addCapability("FormatInfographicsImageUrls")}})),t(s.applyRunReportAndGetDataResults(T,m)).then((function(){return m}))}))}})}));
